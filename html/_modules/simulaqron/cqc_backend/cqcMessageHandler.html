
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>simulaqron.cqc_backend.cqcMessageHandler &#8212; SimulaQron 3.0.16 documentation</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">SimulaQron 3.0.16 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for simulaqron.cqc_backend.cqcMessageHandler</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2017-2018, Stephanie Wehner and Axel Dahlberg</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright</span>
<span class="c1">#    notice, this list of conditions and the following disclaimer.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="c1">#    notice, this list of conditions and the following disclaimer in the</span>
<span class="c1">#    documentation and/or other materials provided with the distribution.</span>
<span class="c1"># 3. All advertising materials mentioning features or use of this software</span>
<span class="c1">#    must display the following acknowledgement:</span>
<span class="c1">#    This product includes software developed by Stephanie Wehner, QuTech.</span>
<span class="c1"># 4. Neither the name of the QuTech organization nor the</span>
<span class="c1">#    names of its contributors may be used to endorse or promote products</span>
<span class="c1">#    derived from this software without specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDER &#39;&#39;AS IS&#39;&#39; AND ANY</span>
<span class="c1"># EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="c1"># WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="c1"># DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE FOR ANY</span>
<span class="c1"># DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<span class="c1"># (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<span class="c1"># LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
<span class="c1"># ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="c1"># (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="c1"># SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>

<span class="kn">from</span> <span class="nn">heapq</span> <span class="kn">import</span> <span class="n">heappush</span><span class="p">,</span> <span class="n">heappop</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">inlineCallbacks</span>
<span class="kn">from</span> <span class="nn">twisted.spread.pb</span> <span class="kn">import</span> <span class="n">RemoteError</span>

<span class="kn">from</span> <span class="nn">cqc.cqcHeader</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CQCCmdHeader</span><span class="p">,</span>
    <span class="n">CQC_TP_HELLO</span><span class="p">,</span>
    <span class="n">CQC_CMD_H</span><span class="p">,</span>
    <span class="n">CQCXtraQubitHeader</span><span class="p">,</span>
    <span class="n">CQC_XTRA_QUBIT_HDR_LENGTH</span><span class="p">,</span>
    <span class="n">CQC_ERR_UNSUPP</span><span class="p">,</span>
    <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span>
    <span class="n">CQC_CMD_HDR_LENGTH</span><span class="p">,</span>
    <span class="n">CQC_TP_INF_TIME</span><span class="p">,</span>
    <span class="n">CQC_NOTIFY_LENGTH</span><span class="p">,</span>
    <span class="n">CQC_ERR_NOQUBIT</span><span class="p">,</span>
    <span class="n">CQCNotifyHeader</span><span class="p">,</span>
    <span class="n">CQCMeasOutHeader</span><span class="p">,</span>
    <span class="n">CQC_MEAS_OUT_HDR_LENGTH</span><span class="p">,</span>
    <span class="n">CQCTimeinfoHeader</span><span class="p">,</span>
    <span class="n">CQC_TIMEINFO_HDR_LENGTH</span><span class="p">,</span>
    <span class="n">CQC_TP_MEASOUT</span><span class="p">,</span>
    <span class="n">CQC_ERR_TIMEOUT</span><span class="p">,</span>
    <span class="n">CQC_ERR_INUSE</span><span class="p">,</span>
    <span class="n">CQC_TP_RECV</span><span class="p">,</span>
    <span class="n">CQC_TP_EPR_OK</span><span class="p">,</span>
    <span class="n">CQC_TP_NEW_OK</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cqc.entInfoHeader</span> <span class="kn">import</span> <span class="n">EntInfoHeader</span><span class="p">,</span> <span class="n">ENT_INFO_LENGTH</span>
<span class="kn">from</span> <span class="nn">cqc.MessageHandler</span> <span class="kn">import</span> <span class="n">CQCMessageHandler</span><span class="p">,</span> <span class="n">UnknownQubitError</span>

<span class="kn">from</span> <span class="nn">simulaqron.virtNode.basics</span> <span class="kn">import</span> <span class="n">quantumError</span><span class="p">,</span> <span class="n">noQubitError</span>
<span class="kn">from</span> <span class="nn">simulaqron.settings</span> <span class="kn">import</span> <span class="n">simulaqron_settings</span>


<div class="viewcode-block" id="SimulaqronCQCHandler"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler">[docs]</a><span class="k">class</span> <span class="nc">SimulaqronCQCHandler</span><span class="p">(</span><span class="n">CQCMessageHandler</span><span class="p">):</span>
    <span class="c1"># Dictionary storing the next unique qubit id for each used app_id</span>
    <span class="n">_available_q_ids</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Dictionary storing the next unique entanglement id for each used (host_app_id,remote_node,remote_app_id)</span>
    <span class="n">_next_ent_id</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factory</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factory</span> <span class="o">=</span> <span class="n">factory</span>

        <span class="c1"># Dictionary that keeps qubit dictorionaries for each application</span>
        <span class="c1"># TODO this is in factory right?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qubitList</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="SimulaqronCQCHandler.get_error_class"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.get_error_class">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_error_class</span><span class="p">(</span><span class="n">remote_err</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a function to get the error class of a remote thrown error when using callRemote.</span>
<span class="sd">        :param remote_err: :obj:`twisted.spread.pb.RemoteError`</span>
<span class="sd">        :return: class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get name of remote error</span>
        <span class="n">error_name</span> <span class="o">=</span> <span class="n">remote_err</span><span class="o">.</span><span class="n">remoteType</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="c1"># Get class of remote error</span>
        <span class="n">error_class</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">error_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">error_class</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.handle_hello"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.handle_hello">[docs]</a>    <span class="k">def</span> <span class="nf">handle_hello</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hello just requires us to return hello - for testing availability.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qubits</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">appID</span><span class="p">,</span> <span class="n">qID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">qubitList</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">qubits</span><span class="p">[</span><span class="n">appID</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qID</span><span class="p">)</span>

        <span class="n">to_print</span> <span class="o">=</span> <span class="s2">&quot;Hello! I&#39;m node </span><span class="si">{}</span><span class="s2"> with the following qubits:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">appID</span><span class="p">,</span> <span class="n">qIDs</span> <span class="ow">in</span> <span class="n">qubits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">to_print</span> <span class="o">+=</span> <span class="s2">&quot;    App ID </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">appID</span><span class="p">,</span> <span class="n">qIDs</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">to_print</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_TP_HELLO</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.handle_time"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.handle_time">[docs]</a>    <span class="k">def</span> <span class="nf">handle_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

        <span class="c1"># Read the command header to learn the qubit ID</span>
        <span class="n">raw_cmd_header</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">CQC_CMD_HDR_LENGTH</span><span class="p">]</span>
        <span class="n">cmd_hdr</span> <span class="o">=</span> <span class="n">CQCCmdHeader</span><span class="p">(</span><span class="n">raw_cmd_header</span><span class="p">)</span>

        <span class="c1"># Get the qubit list</span>
        <span class="n">q_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">qubitList</span>

        <span class="c1"># Lookup the desired qubit</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">cmd_hdr</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">q_list</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q_list</span><span class="p">[(</span><span class="n">header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">cmd_hdr</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Specified qubit is unknown</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_NOQUBIT</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Craft reply</span>
        <span class="c1"># First send an appropriate CQC Header</span>
        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">CQC_NOTIFY_LENGTH</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">CQC_TIMEINFO_HDR_LENGTH</span>
        <span class="n">cqc_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_TP_INF_TIME</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cqc_msg</span><span class="p">)</span>

        <span class="c1"># Then we send a notify header with the timing details</span>
        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">CQCNotifyHeader</span><span class="p">()</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">cmd_hdr</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">CQCTimeinfoHeader</span><span class="p">()</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_i"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_i">[docs]</a>    <span class="k">def</span> <span class="nf">cmd_i</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do nothing. In reality we would wait a timestep but in SimulaQron we just do nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Doing Nothing to App ID </span><span class="si">%d</span><span class="s2"> qubit id </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_x"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_x">[docs]</a>    <span class="k">def</span> <span class="nf">cmd_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply X Gate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_single_qubit_gate</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="s2">&quot;apply_X&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Following error occurred when trying to apply a X gate to qubit </span><span class="si">{}</span><span class="s2">: Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_y"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_y">[docs]</a>    <span class="k">def</span> <span class="nf">cmd_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply Y Gate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_single_qubit_gate</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="s2">&quot;apply_Y&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Following error occurred when trying to apply a Y gate to qubit </span><span class="si">{}</span><span class="s2">: Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_z"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_z">[docs]</a>    <span class="k">def</span> <span class="nf">cmd_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply Z Gate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_single_qubit_gate</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="s2">&quot;apply_Z&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Following error occurred when trying to apply a Z gate to qubit </span><span class="si">{}</span><span class="s2">: Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_t"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_t">[docs]</a>    <span class="k">def</span> <span class="nf">cmd_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply T Gate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_single_qubit_gate</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="s2">&quot;apply_T&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Following error occurred when trying to apply a T gate to qubit </span><span class="si">{}</span><span class="s2">: Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_h"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_h">[docs]</a>    <span class="k">def</span> <span class="nf">cmd_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply H Gate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_single_qubit_gate</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="s2">&quot;apply_H&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Following error occurred when trying to apply a H gate to qubit </span><span class="si">{}</span><span class="s2">: Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_k"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_k">[docs]</a>    <span class="k">def</span> <span class="nf">cmd_k</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply K Gate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_single_qubit_gate</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="s2">&quot;apply_K&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Following error occurred when trying to apply a K gate to qubit </span><span class="si">{}</span><span class="s2">: Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.apply_rotation"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.apply_rotation">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">apply_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a rotation of the qubit specified in cmd with an angle specified in xtra</span>
<span class="sd">        around the axis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Applying a rotation around </span><span class="si">%s</span><span class="s2"> to App ID </span><span class="si">%d</span><span class="s2"> qubit id </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">axis</span><span class="p">,</span>
            <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">virt_qubit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_virt_qubit</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownQubitError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_NOQUBIT</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">virt_qubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;apply_rotation&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">256</span> <span class="o">*</span> <span class="n">xtra</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_UNSUPP</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Following error occurred when trying to apply a rotation gate to qubit </span><span class="si">{}</span><span class="s2">: Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_rotx"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_rotx">[docs]</a>    <span class="k">def</span> <span class="nf">cmd_rotx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate around x axis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rotation</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Following error occurred when trying to apply a ROTX gate to qubit </span><span class="si">{}</span><span class="s2">: Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_roty"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_roty">[docs]</a>    <span class="k">def</span> <span class="nf">cmd_roty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate around y axis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rotation</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Following error occurred when trying to apply a ROTY gate to qubit </span><span class="si">{}</span><span class="s2">: Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_rotz"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_rotz">[docs]</a>    <span class="k">def</span> <span class="nf">cmd_rotz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate around z axis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rotation</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Following error occurred when trying to apply a ROTZ gate to qubit </span><span class="si">{}</span><span class="s2">: Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_cnot"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_cnot">[docs]</a>    <span class="k">def</span> <span class="nf">cmd_cnot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply CNOT Gate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_two_qubit_gate</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">,</span> <span class="s2">&quot;cnot_onto&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Following error occurred when trying to apply a CNOT gate to qubit </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">: Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">xtra</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_cphase"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_cphase">[docs]</a>    <span class="k">def</span> <span class="nf">cmd_cphase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply CPHASE Gate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_two_qubit_gate</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">,</span> <span class="s2">&quot;cphase_onto&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Following error occurred when trying to apply a CPHASE gate to qubit </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">: Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">xtra</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_measure"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_measure">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">cmd_measure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Measure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Measuring App ID </span><span class="si">%d</span><span class="s2"> qubit id </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">virt_qubit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_virt_qubit</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownQubitError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_NOQUBIT</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">outcome</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">virt_qubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;measure&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to measure qubit </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">outcome</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Measurement failed&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Measured outcome </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">outcome</span><span class="p">)</span>

        <span class="c1"># Store the outcome in self.references under the reference specified in the CQCAssignHeader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">references</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">][</span><span class="n">xtra</span><span class="o">.</span><span class="n">ref_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">outcome</span>

        <span class="c1"># Send the outcome back as MEASOUT</span>
        <span class="k">if</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">CQC_NOTIFY_LENGTH</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">CQC_MEAS_OUT_HDR_LENGTH</span>
        <span class="n">cqc_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_TP_MEASOUT</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span>
                                             <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cqc_msg</span><span class="p">)</span>

        <span class="c1"># Send notify header with outcome</span>
        <span class="k">if</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">CQCNotifyHeader</span><span class="p">()</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">CQCMeasOutHeader</span><span class="p">()</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">outcome</span><span class="o">=</span><span class="n">outcome</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1"># self.protocol.transport.write(msg)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Notify </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="c1"># Remove from active mapped qubits</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_qubit_id</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_measure_inplace"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_measure_inplace">[docs]</a>    <span class="k">def</span> <span class="nf">cmd_measure_inplace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_measure</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_reset"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_reset">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">cmd_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset Qubit to \|0\&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Reset App ID </span><span class="si">%d</span><span class="s2"> qubit id </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">virt_qubit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_virt_qubit</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownQubitError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_NOQUBIT</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">outcome</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">virt_qubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;measure&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to reset qubit </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># If state is |1&gt; do correction</span>
        <span class="k">if</span> <span class="n">outcome</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">virt_qubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;apply_X&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to correct a the reset qubit </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_send"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_send">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">cmd_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send qubit to another node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Lookup the name of the remote node used within SimulaQron</span>
        <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">xtra</span><span class="o">.</span><span class="n">remote_node</span><span class="p">,</span> <span class="n">xtra</span><span class="o">.</span><span class="n">remote_port</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Remote node not found </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">xtra</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_UNSUPP</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check so that it is not the same node</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">target_name</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Trying to send from node to itself.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># self.protocol._send_back_cqc(cqc_header, CQC_ERR_GENERAL)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_UNSUPP</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check that other node is adjacent to us</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">is_adjacent</span><span class="p">(</span><span class="n">target_name</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Node </span><span class="si">{}</span><span class="s2"> is not adjacent to </span><span class="si">{}</span><span class="s2"> in the specified topology.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_UNSUPP</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Lookup the virtual qubit from identifier</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">virt_num</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_virt_qubit_indep</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownQubitError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_NOQUBIT</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Send instruction to transfer the qubit</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">virtRoot</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span>
                <span class="s2">&quot;cqc_send_qubit&quot;</span><span class="p">,</span> <span class="n">virt_num</span><span class="p">,</span> <span class="n">target_name</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">xtra</span><span class="o">.</span><span class="n">remote_app_id</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
            <span class="n">error_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_error_class</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error_class</span> <span class="o">==</span> <span class="n">noQubitError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Trying to send qubit but remote node is out of qubits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_NOQUBIT</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">error_class</span> <span class="o">==</span> <span class="n">quantumError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Unknown quantum error occurred when trying to send qubit.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to send qubit </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">remote_err</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to send qubit </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Sent App ID </span><span class="si">%d</span><span class="s2"> qubit id </span><span class="si">%d</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span> <span class="n">target_name</span>
        <span class="p">)</span>

        <span class="c1"># Remove from active mapped qubits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_qubit_id</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_recv"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_recv">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">cmd_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receive qubit from another node. Block until qubit is received.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Asking to receive for App ID </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">)</span>

        <span class="c1"># First get the app_id</span>
        <span class="n">app_id</span> <span class="o">=</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span>

        <span class="c1"># This will block until a qubit is received.</span>
        <span class="n">no_qubit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">virt_qubit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># recv_timeout is in 100ms (for legacy reasons there are no plans to change it to seconds)</span>
        <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">recv_retry_time</span>  <span class="c1"># seconds</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">recv_timeout</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="o">/</span> <span class="n">sleep_time</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">virt_qubit</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">virtRoot</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;cqc_get_recv&quot;</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
                <span class="n">error_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_error_class</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">error_class</span> <span class="o">==</span> <span class="n">quantumError</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Unknown quantum error occurred when trying to recv qubit.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span>
                                                         <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to recv a qubit: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">remote_err</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to recv a qubit: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">virt_qubit</span><span class="p">:</span>
                <span class="n">no_qubit</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">no_qubit</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: TIMEOUT, no qubit received.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># self.protocol._send_back_cqc(cqc_header, CQC_ERR_TIMEOUT)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_TIMEOUT</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Qubit received for app_id </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">)</span>

        <span class="c1"># Once we have the qubit, add it to the local list and send a reply we received it. Note that we will</span>
        <span class="c1"># recheck whether it exists: it could have been added by another connection in the mean time</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

            <span class="c1"># Get new qubit ID</span>
            <span class="n">q_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_qubit_id</span><span class="p">(</span><span class="n">app_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">app_id</span><span class="p">,</span> <span class="n">q_id</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">qubitList</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Qubit already in use (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">app_id</span><span class="p">,</span> <span class="n">q_id</span><span class="p">)</span>
                <span class="c1"># self.protocol._send_back_cqc(cqc_header, CQC_ERR_INUSE)</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_INUSE</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">q</span> <span class="o">=</span> <span class="n">CQCQubit</span><span class="p">(</span><span class="n">q_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span> <span class="n">virt_qubit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">qubitList</span><span class="p">[(</span><span class="n">app_id</span><span class="p">,</span> <span class="n">q_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">q</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="c1"># Send message we received a qubit back</span>
        <span class="k">if</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">CQC_NOTIFY_LENGTH</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">CQC_XTRA_QUBIT_HDR_LENGTH</span>
        <span class="n">recv_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_TP_RECV</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span>
                                              <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recv_msg</span><span class="p">)</span>

        <span class="c1"># Send notify header with qubit ID</span>
        <span class="k">if</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">CQCNotifyHeader</span><span class="p">()</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">q_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">CQCXtraQubitHeader</span><span class="p">()</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">qubit_id</span><span class="o">=</span><span class="n">q_id</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
        <span class="c1"># self.protocol.transport.write(msg)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Notify </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_epr"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_epr">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">cmd_epr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create EPR pair with another node.</span>
<span class="sd">        Depending on the ips and ports this will either create an EPR-pair and send one part, or just receive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get ip and port of this host</span>
        <span class="n">host_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">ip</span>
        <span class="n">host_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">port</span>
        <span class="n">host_app_id</span> <span class="o">=</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span>

        <span class="c1"># Get ip and port of remote host</span>
        <span class="n">remote_node</span> <span class="o">=</span> <span class="n">xtra</span><span class="o">.</span><span class="n">remote_node</span>
        <span class="n">remote_port</span> <span class="o">=</span> <span class="n">xtra</span><span class="o">.</span><span class="n">remote_port</span>
        <span class="n">remote_app_id</span> <span class="o">=</span> <span class="n">xtra</span><span class="o">.</span><span class="n">remote_app_id</span>

        <span class="c1"># Lookup the name of the remote node used within SimulaQron</span>
        <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">remote_node</span><span class="p">,</span> <span class="n">remote_port</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Remote node not found </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">xtra</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_UNSUPP</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check so that it is not the same node</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">target_name</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Trying to create EPR from node to itself.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># self.protocol._send_back_cqc(cqc_header, CQC_ERR_GENERAL)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_UNSUPP</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check that other node is adjacent to us</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">is_adjacent</span><span class="p">(</span><span class="n">target_name</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Node </span><span class="si">{}</span><span class="s2"> is not adjacent to </span><span class="si">{}</span><span class="s2"> in the specified topology.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_UNSUPP</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Create the first qubit</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">succ</span><span class="p">,</span> <span class="n">q_id1</span><span class="p">)</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_new</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">,</span> <span class="n">return_q_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
            <span class="n">error_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_error_class</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
            <span class="n">succ</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">error_class</span> <span class="o">==</span> <span class="n">noQubitError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Trying to create qubit for EPR but out of qubits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_NOQUBIT</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">error_class</span> <span class="o">==</span> <span class="n">quantumError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Unknown quantum error occurred when trying to create qubit for EPR.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to create qubit for EPR: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">remote_err</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to create qubit for EPR: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">succ</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Create the second qubit</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">succ</span><span class="p">,</span> <span class="n">q_id2</span><span class="p">)</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_new</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">,</span> <span class="n">return_q_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_max_qubits</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to create qubit for EPR: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">succ</span><span class="p">:</span>
            <span class="c1"># Failed to create the second qubit, destroy the first</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Failed to create second qubit, destroying the first&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmd1</span> <span class="o">=</span> <span class="n">CQCCmdHeader</span><span class="p">()</span>
                <span class="n">cmd1</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">q_id1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_release</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Failed to destroy qubits&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Create headers for qubits</span>
        <span class="n">cmd1</span> <span class="o">=</span> <span class="n">CQCCmdHeader</span><span class="p">()</span>
        <span class="n">cmd1</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">q_id1</span><span class="p">,</span> <span class="n">CQC_CMD_H</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">cmd2</span> <span class="o">=</span> <span class="n">CQCCmdHeader</span><span class="p">()</span>
        <span class="n">cmd2</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">q_id2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">xtra_cnot</span> <span class="o">=</span> <span class="n">CQCXtraQubitHeader</span><span class="p">()</span>
        <span class="n">xtra_cnot</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">q_id2</span><span class="p">)</span>

        <span class="c1"># Produce EPR-pair</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_h</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to apply H to EPR qubit: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="n">succ</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">succ</span><span class="p">:</span>
            <span class="c1"># Failed to perform H, destroy qubits</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Failed to perform H, destroying qubits&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_release</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Failed to destroy qubits&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_release</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Failed to destroy qubits&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_cnot</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd1</span><span class="p">,</span> <span class="n">xtra_cnot</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to apply CNOT to EPR qubit: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="n">succ</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">succ</span><span class="p">:</span>
            <span class="c1"># Failed to perform CNOT, destroy qubits</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Failed to perform CNOT, destroying qubits&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_release</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Failed to destroy qubits&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_release</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Failed to destroy qubits&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Get entanglement id XXX lock here?</span>
        <span class="n">ent_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_ent_id</span><span class="p">(</span><span class="n">host_app_id</span><span class="p">,</span> <span class="n">remote_node</span><span class="p">,</span> <span class="n">remote_app_id</span><span class="p">)</span>

        <span class="c1"># Prepare ent_info header with entanglement information</span>
        <span class="n">ent_info</span> <span class="o">=</span> <span class="n">EntInfoHeader</span><span class="p">()</span>
        <span class="n">ent_info</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span>
            <span class="n">host_node</span><span class="p">,</span>
            <span class="n">host_port</span><span class="p">,</span>
            <span class="n">host_app_id</span><span class="p">,</span>
            <span class="n">remote_node</span><span class="p">,</span>
            <span class="n">remote_port</span><span class="p">,</span>
            <span class="n">remote_app_id</span><span class="p">,</span>
            <span class="n">ent_id</span><span class="p">,</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Send second qubit</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">succ</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_epr_half</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd2</span><span class="p">,</span> <span class="n">xtra</span><span class="p">,</span> <span class="n">ent_info</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
            <span class="n">error_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_error_class</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
            <span class="n">succ</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">error_class</span> <span class="o">==</span> <span class="n">noQubitError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Trying to send qubit of EPR but remote node is out of qubits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_NOQUBIT</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">error_class</span> <span class="o">==</span> <span class="n">quantumError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Unknown quantum error occurred when trying to send qubit of EPR.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to send EPR qubit: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">remote_err</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to send EPR qubit: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">succ</span><span class="p">:</span>
            <span class="c1"># Failed to send the qubit, destroy it instead</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Failed to send epr qubit, destroying qubits&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_release</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Failed to destroy qubits&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_release</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Failed to destroy qubits&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Send message we created EPR pair</span>
        <span class="k">if</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">CQC_NOTIFY_LENGTH</span> <span class="o">+</span> <span class="n">ENT_INFO_LENGTH</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">CQC_XTRA_QUBIT_HDR_LENGTH</span> <span class="o">+</span> <span class="n">ENT_INFO_LENGTH</span>
        <span class="n">msg_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span>
            <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_TP_EPR_OK</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg_ok</span><span class="p">)</span>

        <span class="c1"># Send notify header with qubit ID</span>
        <span class="k">if</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">CQCNotifyHeader</span><span class="p">()</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">q_id1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">CQCXtraQubitHeader</span><span class="p">()</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">qubit_id</span><span class="o">=</span><span class="n">q_id1</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Notify </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="p">)</span>

        <span class="c1"># Send entanglement info</span>
        <span class="n">msg_ent_info</span> <span class="o">=</span> <span class="n">ent_info</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg_ent_info</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Entanglement information </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ent_info</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: EPR Pair ID </span><span class="si">%d</span><span class="s2"> qubit id </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.send_epr_half"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.send_epr_half">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">send_epr_half</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">,</span> <span class="n">ent_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send qubit to another node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Lookup the virtual qubit from identifier</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">virt_num</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_virt_qubit_indep</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownQubitError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="c1"># Lookup the name of the remote node used within SimulaQron</span>
        <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">xtra</span><span class="o">.</span><span class="n">remote_node</span><span class="p">,</span> <span class="n">xtra</span><span class="o">.</span><span class="n">remote_port</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Remote node not found </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">xtra</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Prepare update raw entanglement information header</span>
        <span class="n">updated_ent_info</span> <span class="o">=</span> <span class="n">EntInfoHeader</span><span class="p">(</span><span class="n">ent_info</span><span class="o">.</span><span class="n">pack</span><span class="p">())</span>
        <span class="n">updated_ent_info</span><span class="o">.</span><span class="n">switch_nodes</span><span class="p">()</span>
        <span class="n">raw_updated_ent_info</span> <span class="o">=</span> <span class="n">updated_ent_info</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
        <span class="c1"># Send instruction to transfer the qubit</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">virtRoot</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span>
                <span class="s2">&quot;cqc_send_epr_half&quot;</span><span class="p">,</span> <span class="n">virt_num</span><span class="p">,</span> <span class="n">target_name</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">xtra</span><span class="o">.</span><span class="n">remote_app_id</span><span class="p">,</span> <span class="n">raw_updated_ent_info</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Sent App ID </span><span class="si">%d</span><span class="s2"> half a EPR pair as qubit id </span><span class="si">%d</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span>
            <span class="n">target_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Remove from active mapped qubits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_qubit_id</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_epr_recv"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_epr_recv">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">cmd_epr_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receive half of epr from another node. Block until qubit is received.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Asking to receive for App ID </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">)</span>

        <span class="c1"># First get the app_id and q_id</span>
        <span class="n">app_id</span> <span class="o">=</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span>
        <span class="n">q_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_qubit_id</span><span class="p">(</span><span class="n">app_id</span><span class="p">)</span>

        <span class="c1"># This will block until a qubit is received.</span>
        <span class="n">no_qubit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">virt_qubit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ent_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># recv_timeout is in 100ms (for legacy reasons there are no plans to change it to seconds)</span>
        <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">recv_retry_time</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">recv_timeout</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="o">/</span> <span class="n">sleep_time</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">virtRoot</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;cqc_get_epr_recv&quot;</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
                <span class="n">error_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_error_class</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">error_class</span> <span class="o">==</span> <span class="n">quantumError</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Unknown quantum error occurred when trying to recv qubit of EPR.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span>
                                                         <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to recv EPR qubit: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">remote_err</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to send EPR qubit: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">no_qubit</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="p">(</span><span class="n">virt_qubit</span><span class="p">,</span> <span class="n">rawEntInfo</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">ent_info</span> <span class="o">=</span> <span class="n">EntInfoHeader</span><span class="p">(</span><span class="n">rawEntInfo</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">no_qubit</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: TIMEOUT, no qubit received.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># self.protocol._send_back_cqc(cqc_header, CQC_ERR_TIMEOUT)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_TIMEOUT</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Qubit received for app_id </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">)</span>

        <span class="c1"># Once we have the qubit, add it to the local list and send a reply we received it. Note that we will</span>
        <span class="c1"># recheck whether it exists: it could have been added by another connection in the mean time</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">app_id</span><span class="p">,</span> <span class="n">q_id</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">qubitList</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Qubit already in use (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">app_id</span><span class="p">,</span> <span class="n">q_id</span><span class="p">)</span>
                <span class="c1"># self.protocol._send_back_cqc(cqc_header, CQC_ERR_INUSE)</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_INUSE</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">q</span> <span class="o">=</span> <span class="n">CQCQubit</span><span class="p">(</span><span class="n">q_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span> <span class="n">virt_qubit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">qubitList</span><span class="p">[(</span><span class="n">app_id</span><span class="p">,</span> <span class="n">q_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">q</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="c1"># Send message we received a qubit back</span>
        <span class="k">if</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">CQC_NOTIFY_LENGTH</span> <span class="o">+</span> <span class="n">ENT_INFO_LENGTH</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">CQC_XTRA_QUBIT_HDR_LENGTH</span> <span class="o">+</span> <span class="n">ENT_INFO_LENGTH</span>
        <span class="n">cqc_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span>
            <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_TP_EPR_OK</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cqc_msg</span><span class="p">)</span>

        <span class="c1"># Send notify header with qubit ID</span>
        <span class="k">if</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">CQCNotifyHeader</span><span class="p">()</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">q_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Notify </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">CQCXtraQubitHeader</span><span class="p">()</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">qubit_id</span><span class="o">=</span><span class="n">q_id</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Send entanglement info</span>
        <span class="n">ent_info_msg</span> <span class="o">=</span> <span class="n">ent_info</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ent_info_msg</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Entanglement information </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ent_info</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: EPR Pair ID </span><span class="si">%d</span><span class="s2"> qubit id </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_new"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_new">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">cmd_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">,</span> <span class="n">return_q_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignore_max_qubits</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Request a new qubit. Since we don&#39;t need it, this python CQC just provides very crude timing information.</span>
<span class="sd">        (return_q_id is used internally)</span>
<span class="sd">        (ignore_max_qubits is used internally to ignore the check of number of virtual qubits at the node</span>
<span class="sd">        such that the node can temporarily create a qubit for EPR creation.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">app_id</span> <span class="o">=</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">virt</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">virtRoot</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;new_qubit&quot;</span><span class="p">,</span> <span class="n">ignore_max_qubits</span><span class="o">=</span><span class="n">ignore_max_qubits</span><span class="p">)</span>
                <span class="n">succ</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
                <span class="n">error_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_error_class</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
                <span class="n">succ</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">error_class</span> <span class="o">==</span> <span class="n">noQubitError</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Out of simulated qubits in register or virtual qubits in node&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_NOQUBIT</span><span class="p">,</span>
                                                         <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">error_class</span> <span class="o">==</span> <span class="n">quantumError</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Unknown quantum error occurred when trying to create new qubit.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span>
                                                         <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to create new qubit: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">remote_err</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">succ</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to create new qubit: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">succ</span><span class="p">:</span>
                <span class="n">q_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_qubit_id</span><span class="p">(</span><span class="n">app_id</span><span class="p">)</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">CQCQubit</span><span class="p">(</span><span class="n">q_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span> <span class="n">virt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">qubitList</span><span class="p">[(</span><span class="n">app_id</span><span class="p">,</span> <span class="n">q_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">q</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Requested new qubit (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">app_id</span><span class="p">,</span> <span class="n">q_id</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">return_q_id</span><span class="p">:</span>
                    <span class="c1"># Send message we created a qubit back</span>
                    <span class="k">if</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">length</span> <span class="o">=</span> <span class="n">CQC_NOTIFY_LENGTH</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">length</span> <span class="o">=</span> <span class="n">CQC_XTRA_QUBIT_HDR_LENGTH</span>
                    <span class="n">cqc_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_TP_NEW_OK</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span>
                                                         <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cqc_msg</span><span class="p">)</span>

                    <span class="c1"># Send notify header with qubit ID</span>
                    <span class="k">if</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">hdr</span> <span class="o">=</span> <span class="n">CQCNotifyHeader</span><span class="p">()</span>
                        <span class="n">hdr</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">q_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Notify </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hdr</span> <span class="o">=</span> <span class="n">CQCXtraQubitHeader</span><span class="p">()</span>
                        <span class="n">hdr</span><span class="o">.</span><span class="n">setVals</span><span class="p">(</span><span class="n">qubit_id</span><span class="o">=</span><span class="n">q_id</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">return_q_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">succ</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">succ</span><span class="p">,</span> <span class="n">q_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">succ</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">succ</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_allocate"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_allocate">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">cmd_allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allocate multiple qubits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_qubits</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Allocating </span><span class="si">%d</span><span class="s2"> qubits&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">num_qubits</span><span class="p">)</span>
        <span class="n">succ</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">):</span>
                <span class="n">succ_tmp</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_new</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">)</span>
                <span class="n">succ</span> <span class="o">=</span> <span class="n">succ</span> <span class="ow">and</span> <span class="n">succ_tmp</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Got the following unexpected error when trying to create allocate qubits: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">succ</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.cmd_release"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.cmd_release">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">cmd_release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Release</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Releasing App ID </span><span class="si">%d</span><span class="s2"> qubit id </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">virt_qubit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_virt_qubit</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownQubitError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_NOQUBIT</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">outcome</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">virt_qubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;measure&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Following unknown error occurred when trying to release qubit by measuring: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">outcome</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Release failed&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_GENERAL</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remove_qubit_id</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.apply_single_qubit_gate"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.apply_single_qubit_gate">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">apply_single_qubit_gate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">qubit_id</span><span class="p">,</span> <span class="n">gate</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> on App ID </span><span class="si">%d</span><span class="s2"> to qubit id </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">gate</span><span class="p">,</span> <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">virt_qubit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_virt_qubit</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownQubitError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_NOQUBIT</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">virt_qubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="n">gate</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_UNSUPP</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.apply_two_qubit_gate"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.apply_two_qubit_gate">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">apply_two_qubit_gate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">xtra</span><span class="p">,</span> <span class="n">gate</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">xtra</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Missing XTRA Header&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_UNSUPP</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1">#</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;CQC </span><span class="si">%s</span><span class="s2">: Applying </span><span class="si">%s</span><span class="s2"> to App ID </span><span class="si">%d</span><span class="s2"> qubit id </span><span class="si">%d</span><span class="s2"> target </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">gate</span><span class="p">,</span>
            <span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span>
            <span class="n">xtra</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_virt_qubit</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_virt_qubit</span><span class="p">(</span><span class="n">cqc_header</span><span class="p">,</span> <span class="n">xtra</span><span class="o">.</span><span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownQubitError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_NOQUBIT</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Return an error if the control and target are equal, can not do this</span>
        <span class="k">if</span> <span class="n">control</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_UNSUPP</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">control</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="n">gate</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_return_message</span><span class="p">(</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">CQC_ERR_UNSUPP</span><span class="p">,</span> <span class="n">cqc_version</span><span class="o">=</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_messages</span><span class="p">[</span><span class="n">cqc_header</span><span class="o">.</span><span class="n">app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.get_virt_qubit"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.get_virt_qubit">[docs]</a>    <span class="k">def</span> <span class="nf">get_virt_qubit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">qubit_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get reference to the virtual qubit reference in SimulaQron given app and qubit id, if it exists.</span>
<span class="sd">        If not found, send back no qubit error.</span>

<span class="sd">        Caution: Twisted PB does not allow references to objects to be passed back between connections.</span>
<span class="sd">        If you need to pass a qubit reference back to the Twisted PB on a _different_ connection,</span>
<span class="sd">        then use get_virt_qubit_indep below.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">qubit_id</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">qubitList</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnknownQubitError</span><span class="p">(</span><span class="s2">&quot;CQC </span><span class="si">{}</span><span class="s2">: Qubit not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">qubit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">qubitList</span><span class="p">[(</span><span class="n">header</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">qubit_id</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">qubit</span><span class="o">.</span><span class="n">virt</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.get_virt_qubit_indep"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.get_virt_qubit_indep">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">get_virt_qubit_indep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">qubit_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get NUMBER (not reference!) to virtual qubit in SimulaQron specific to this connection.</span>
<span class="sd">        If not found, send back no qubit error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First let&#39;s get the general virtual qubit reference, if any</span>
        <span class="n">general_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_virt_qubit</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">qubit_id</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">general_ref</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_virt_num&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="k">return</span> <span class="n">num</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.new_qubit_id"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.new_qubit_id">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">new_qubit_id</span><span class="p">(</span><span class="n">app_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new unique qubit id for the specified app_id. Used by cmd_new and cmd_recv</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">app_id</span> <span class="ow">in</span> <span class="n">SimulaqronCQCHandler</span><span class="o">.</span><span class="n">_available_q_ids</span><span class="p">:</span>
            <span class="n">q_ids</span> <span class="o">=</span> <span class="n">SimulaqronCQCHandler</span><span class="o">.</span><span class="n">_available_q_ids</span><span class="p">[</span><span class="n">app_id</span><span class="p">]</span>
            <span class="n">q_id</span> <span class="o">=</span> <span class="n">heappop</span><span class="p">(</span><span class="n">q_ids</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">q_ids</span><span class="p">:</span>
                <span class="n">heappush</span><span class="p">(</span><span class="n">q_ids</span><span class="p">,</span> <span class="n">q_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">q_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">SimulaqronCQCHandler</span><span class="o">.</span><span class="n">_available_q_ids</span><span class="p">[</span><span class="n">app_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">heappush</span><span class="p">(</span><span class="n">SimulaqronCQCHandler</span><span class="o">.</span><span class="n">_available_q_ids</span><span class="p">[</span><span class="n">app_id</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

            <span class="k">return</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.new_ent_id"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.new_ent_id">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">new_ent_id</span><span class="p">(</span><span class="n">host_app_id</span><span class="p">,</span> <span class="n">remote_node</span><span class="p">,</span> <span class="n">remote_app_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new unique entanglement id for the specified host_app_id, remote_node and remote_app_id.</span>
<span class="sd">        Used by cmd_epr.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pair_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">host_app_id</span><span class="p">,</span> <span class="n">remote_node</span><span class="p">,</span> <span class="n">remote_app_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pair_id</span> <span class="ow">in</span> <span class="n">SimulaqronCQCHandler</span><span class="o">.</span><span class="n">_next_ent_id</span><span class="p">:</span>
            <span class="n">ent_id</span> <span class="o">=</span> <span class="n">SimulaqronCQCHandler</span><span class="o">.</span><span class="n">_next_ent_id</span><span class="p">[</span><span class="n">pair_id</span><span class="p">]</span>
            <span class="n">SimulaqronCQCHandler</span><span class="o">.</span><span class="n">_next_ent_id</span><span class="p">[</span><span class="n">pair_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">ent_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">SimulaqronCQCHandler</span><span class="o">.</span><span class="n">_next_ent_id</span><span class="p">[</span><span class="n">pair_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="SimulaqronCQCHandler.remove_qubit_id"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.SimulaqronCQCHandler.remove_qubit_id">[docs]</a>    <span class="k">def</span> <span class="nf">remove_qubit_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_id</span><span class="p">,</span> <span class="n">qubit_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove qubit id from current used qubit_id so it can be reused</span>
<span class="sd">        :param app_id: The app id of the current qubit_id</span>
<span class="sd">        :param qubit_id: The qubit id to be removed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">app_id</span> <span class="ow">in</span> <span class="n">SimulaqronCQCHandler</span><span class="o">.</span><span class="n">_available_q_ids</span><span class="p">:</span>
            <span class="n">q_ids</span> <span class="o">=</span> <span class="n">SimulaqronCQCHandler</span><span class="o">.</span><span class="n">_available_q_ids</span><span class="p">[</span><span class="n">app_id</span><span class="p">]</span>
            <span class="n">heappush</span><span class="p">(</span><span class="n">q_ids</span><span class="p">,</span> <span class="n">qubit_id</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">qubitList</span><span class="p">[(</span><span class="n">app_id</span><span class="p">,</span> <span class="n">qubit_id</span><span class="p">)]</span></div></div>


<span class="c1">#######################################################################################################</span>
<span class="c1">#</span>
<span class="c1"># CQC Internal qubit object to translate to the native mode of SimulaQron</span>
<span class="c1">#</span>


<div class="viewcode-block" id="CQCQubit"><a class="viewcode-back" href="../../../simulaqron.cqc_backend.html#simulaqron.cqc_backend.cqcMessageHandler.CQCQubit">[docs]</a><span class="k">class</span> <span class="nc">CQCQubit</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qubit_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">virt</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qubit_id</span> <span class="o">=</span> <span class="n">qubit_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">virt</span> <span class="o">=</span> <span class="n">virt</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">SimulaQron 3.0.16 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Stephanie Wehner and Axel Dahlberg.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.
    </div>
  </body>
</html>